# 1. BepInEx

BepInEx는 범용 유니티 모드로더(Mod Loader)이다. 공식적으로 모드 기능을 지원하지 않는 유니티 게임들에도 모드를 적용할 수 있게 되었다. BepInEx는  [BepinEx 공식 Github](https://github.com/BepInEx/BepInEx) 에서 소스코드와 바이너리 파일들(Release 참고)을 다운로드 받을 수 있다. BepInEx의 설치는 매우 간단한데, 모딩하고자 하는 게임의 폴더에 다운로드 받은 BepInEx 파일들을 이동시키면 된다. BepInEx가 설치된 이후에는 게임의 어셈블리 파일과 BepInEx 라이브러리 파일을 활용해서 모드 개발을 시작할 수 있다.

BepInEx의 설치와 플러그인 제작방법 등에 대한 자세한 자료는 [BepInEx 공식 문서](https://docs.bepinex.dev/index.html)를 참고하기를 바란다.

# 2. H3VR의 기본적인 시스템 이해하기

H3VR에서는 구의 형태로 나타나는 인터랙션 포인트와 각 손(Hand)가 존재한다. 각 손에는 인터랙션 포인트가 2개 달려있지만, 둘 중 어느 하나의 인터랙션 포인트가 사용되면, 남은 인터랙션 포인트를 사용할 수 없다. 즉, 다시 말해서 각 손은 하나의 물체만을 집을 수 있다. 이 점이 총기의 조준선을 나타나게 하는데에 필요한 변수를 줄여준다. 다시 말해서. 양 손에 총기를 잡고 발사하는 경우까지 고려했을 때, 필요한 조준선(직선) 객체를 담을 게임 오브젝트는 2개면 충분하다는 것이다.

H3VR에서는 총기가 FVRFireArm이라는 클래스로 구현되어 있다. 목표는 조준선을 표시하는 것이므로 필요한 것은 총구가 어디로 향하고 있는지에 대한 정보이다. 이 정보는 FVRFireArm 클래스에서 GetMuzzle() 함수를 통해서 Transform의 형태로 얻어올 수 있으며, 이 얻어온 Transform의 forward 멤버 변수를 통해서 총구가 어디를 가리키고 있는지를 확인할 수 있다.

# 3. 구현 방법

먼저 조준선은 총구가 가리키는 방향을 따라가야 하므로 총기가 업데이트될때 조준선 또한 같이 업데이트 되어야 한다. 조준선의 경우에는 임의의 게임 오브젝트를 만들고, 해당 오브젝트에 LineRenderer 컴포넌트를 부착해서, 매 업데이트마다 이전 게임 오브젝트를 지우고 새로운 게임 오브젝트를 생성하는 것이지만 이 경우에는 조준선이 '점멸'하듯이 보여서 보기에도 좋지 않을 뿐만 아니라 성능면에서도 좋지 않을 것이 자명하다.

2에서 언급했듯이, 각 손은 하나의 오브젝트만을 '쥘' 수 있다. 게임 내에서 손 객체는 두개이므로 우리가 발사 방향을 표시할 총구 또한 최대 두개이다. 따라서 조준선 게임 오브젝트를 담을 변수 두개를 패치 클래스 내부에 static으로 선언한 다음에, 게임 업데이트 때는 변수에 값이 할당되어 있는지를 검사하고, 할당되어 있지 않고 null이라면 게임 오브젝트를 생성한 다음에, LineRenderer를 부착하고, 이제 부착된 LineRenderer의 시작점과 끝점을 정해주면 끝난다.

LineRenderer의 시작지점은 단순히 총구가 될 것이므로 GetMuzzle().position으로 시작지점을 설정해준다. 그런다음에 총구가 가리키는 방향으로 특정한 물체에 닿을때까지, 즉 총구에서 나온 조준선이 특정 물체에 닿는 지점까지가 조준선이 그려지는 목표지점이다. 이를 위해서 UnityEngine.Physics.RayCast를 활용해서 도착지점을 구한다.

조준선의 색깔은 startColor와 endColor로 조정이 가능하다. 원하는 색깔을 입려갛고, startWidth와 endWidth를 적절히 보기좋은 범위 내에서 조절하면 조준선을 그리는 과정은 끝이 난다. 하지만 총을 내려놓았을 때에도 계속해서 조준선이 남아있는 것은 보기에 별로 좋지 않다. 따라서 FVRFireArm의 EndInteraction 함수에 HarmonyPatch를 적용해서 인터랙션이 끝나면 조준선의 활성화 여부를 SetActive 함수를 통해서 비활성 상태로 돌려놓으면 끝이 난다.

# 4. 동작 화면

<p align="center">
    <img src="../../Figure/H3VRAimingLinePresentation.webp"></img></br>
    [그림 1] 시연 영상    
</p>
